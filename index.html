<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>pixi</title>
  <!-- rem -->
  <script>
    (function (win, doc) {
      if (!win.addEventListener) return;
      var html = document.documentElement;
      function setFont() {
        var html = document.documentElement;
        var k = 750;
        html.style.fontSize = (html.clientWidth / k * 100 > 100 ? 100 : html.clientWidth / k * 100) + "px";
      }
      setFont();
      setTimeout(function () {
        setFont();
      }, 300);
      doc.addEventListener('DOMContentLoaded', setFont, false);
      win.addEventListener('resize', setFont, false);
      win.addEventListener('load', setFont, false);
    })(window, document);
  </script>
  <script src="js/pixi.min.js"></script>
  <script src="js/scaleToWindow.js"></script>
  <script src="js/pixi-filters.js"></script>
  <script src="js/TweenMax.min.js"></script>
  <script src="js/spriteUtilities.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      cursor: url(images/finger.png), auto;
    }

    .dialog {
      background: url(images/dialogBg.png) no-repeat 0 0 / 100% 100%;
      width: 3.76rem;
      height: 1.88rem;
      position: fixed;
      top: 50%;
      left: 50%;
      margin-left: -1.88rem;
      margin-top: -0.94rem;
      z-index: 9999;
      display: none;
      transform: scale(0.1);
      animation: scaleAni 0.5s ease-in-out forwards;
    }

    @keyframes scaleAni {
      0% {
        transform: scale(0.1);
      }

      100% {
        transform: scale(1.5);
      }
    }

    .title {
      display: block;
      width: 2.5rem;
      height: 0.47rem;
      margin: 0.3rem auto 0;
    }

    .btnBox {
      width: 3.3rem;
      height: 0.43rem;
      display: flex;
      justify-content: space-between;
      margin: 0.3rem auto;
    }

    .btnBox button {
      width: 1.54rem;
      margin: 0;
      padding: 0;
      border: 1px solid transparent;
      background-color: transparent;
      outline: none;
      cursor: url(images/finger.png), auto;
    }

    .btnBox button img {
      display: block;
      width: 100%;
    }

    .ani {
      animation: pulse 0.4s ease-in-out infinite;
    }

    @keyframes pulse {
      0% {
        -webkit-transform: scaleX(1);
        transform: scaleX(1);
      }

      50% {
        -webkit-transform: scale3d(1.1, 1.1, 1.1);
        transform: scale3d(1.1, 1.1, 1.1);
      }

      100% {
        -webkit-transform: scaleX(1);
        transform: scaleX(1);
      }
    }
  </style>
</head>

<body>

  <div class="dialog">
    <img src="images/dialogInfo.png" alt="" class="title">
    <div class="btnBox">
      <button class="yes ani">
        <img src="images/yes.png" alt="">
      </button>
      <button class="no">
        <img src="images/no.png" alt="">
      </button>
    </div>
  </div>

  <script>
    let yesBtn = document.querySelector(".yes")
    let noBtn = document.querySelector(".no")
    yesBtn.onclick = function (e) {
      e.stopPropagation();
      FbPlayableAd.onCTAClick()
    }
    noBtn.onclick = function (e) {
      e.stopPropagation();

    }

    // 检测是否支持WebGL
    let type = "WebGL"
    if (!PIXI.utils.isWebGLSupported()) {
      type = "canvas"
    }
    PIXI.utils.sayHello(type)

    // 创建舞台
    let app = new PIXI.Application({
      width: 750,
      height: 750
    })
    app.renderer.autoResize = true;
    document.body.appendChild(app.view)
    scaleToWindow(app.view);
    window.addEventListener("resize", function (event) {
      scaleToWindow(app.view);
    });

    let defaultIcon = "url('images/finger.png'), auto";
    app.renderer.plugins.interaction.cursorStyles.default = defaultIcon;

    let su = new SpriteUtilities(PIXI);

    // 资源通过loader加载到纹理缓存中
    PIXI.loader
      .add([
        "images/daiji.png",
        "images/huanhu.png",
        "images/jiaozheng.png",
        "images/jzhdj.png",
        "images/bucket.png",
        "images/finger.png",
        "images/bg.png",
        "images/fire.png",
        "images/bandage.png",
        "images/water.png",
        "images/sshdj.png",
        "images/jzhbj.png",
        "images/lightmap.png",
        "images/hand.png",
        "images/xue1.png",
        "images/xue2.png",
        "images/Thanks.png",
        "images/Nice.png",
        "images/death.png",
        "images/install.png"
      ])
      .on("progress", loadProgressHandler)
      .load(setup)

    function loadProgressHandler(loader, resource) {
      console.log(`${resource.url}: ${loader.progress}%`)
    }

    let bg, finger, bucket, bandage, fire, water, hh, dj, jzhdj, jzh, circle, sshdj, bjArea, bj, jzhbj, jzhhh, gestures, gestures2, gestures3, xue, xue2, thanks, Nice, death;
    let mask = document.querySelector('.mask')
    let dialog = document.querySelector('.dialog')

    function setup() {

      // 背景
      bg = new PIXI.Sprite(
        PIXI.loader.resources["images/bg.png"].texture
      );

      bg.width = 750
      bg.height = 750
      bg.position.set(0, 0)
      app.stage.addChild(bg)
      bg.scale.set(2)



      // 待机
      let djArr = su.filmstrip("images/daiji.png", 250, 250);
      dj = new PIXI.extras.AnimatedSprite(djArr)
      dj.width = 500
      dj.height = 500
      dj.position.set(0, 300)
      dj.animationSpeed = 0.2;
      app.stage.addChild(dj)
      dj.interactive = true;
      dj.loop = true
      dj.play();


      // 着火
      let fireArr = su.filmstrip("images/fire.png", 200, 200);
      fire = new PIXI.extras.AnimatedSprite(fireArr)
      fire.width = 300
      fire.height = 300
      fire.position.set(40, 190)
      fire.animationSpeed = 0.3;
      app.stage.addChild(fire)
      fire.interactive = true;
      fire.loop = true
      fire.play();

      // 浇水
      let waterArr = su.filmstrip("images/water.png", 400, 400);
      water = new PIXI.extras.AnimatedSprite(waterArr)
      water.width = 300
      water.height = 300
      water.position.set(40, 170)
      water.animationSpeed = 0.3;
      // app.stage.addChild(water)
      water.loop = false
      // water.play();

      // 欢呼
      let hhArr = su.filmstrip("images/huanhu.png", 250, 250);
      hh = new PIXI.extras.AnimatedSprite(hhArr)
      hh.width = 500
      hh.height = 500
      hh.position.set(0, 300)
      hh.animationSpeed = 0.15;
      hh.interactive = true;
      hh.loop = false

      // 受伤的脚
      sshdj = new PIXI.Sprite(
        PIXI.loader.resources["images/sshdj.png"].texture
      );
      sshdj.width = 40
      sshdj.height = 40
      sshdj.position.set(200, 650)
      app.stage.addChild(sshdj)

      // 脚正
      let jzhArr = su.filmstrip("images/jiaozheng.png", 250, 250);
      jzh = new PIXI.extras.AnimatedSprite(jzhArr)
      jzh.width = 500
      jzh.height = 500
      jzh.position.set(0, 300)
      jzh.animationSpeed = 0.2;
      // app.stage.addChild(jzh)
      jzh.interactive = true;
      jzh.loop = false

      // 脚正待机
      let jzhdjArr = su.filmstrip("images/jzhdj.png", 250, 250);
      jzhdj = new PIXI.extras.AnimatedSprite(jzhdjArr)
      jzhdj.width = 500
      jzhdj.height = 500
      jzhdj.position.set(0, 300)
      jzhdj.animationSpeed = 0.15;
      jzhdj.interactive = true;
      jzhdj.loop = true
      jzhdj.play();

      // 绷带
      bandage = new PIXI.Sprite(
        PIXI.loader.resources["images/bandage.png"].texture
      );
      bandage.width = 293
      bandage.height = 285
      bandage.position.set(600, 180)
      bandage.interactive = false;
      bandage.anchor.set(0.5);
      bandage.scale.set(0.5)
      bandage.on('pointerdown', onDragStart)
        .on('pointerup', onDragEnd)
        .on('pointerupoutside', onDragEnd)
        .on('pointermove', onDragMove);

      app.stage.addChild(bandage)

      // 水桶
      bucket = new PIXI.Sprite(
        PIXI.loader.resources["images/bucket.png"].texture
      );
      bucket.width = 150
      bucket.height = 150
      bucket.position.set(600, 360)
      bucket.interactive = true;
      bucket.anchor.set(0.5);
      bucket.on('pointerdown', onDragStart)
        .on('pointerup', onDragEnd)
        .on('pointerupoutside', onDragEnd)
        .on('pointermove', onDragMove);

      app.stage.addChild(bucket)

      // 脚正拔箭
      let jzhbjArr = su.filmstrip("images/jzhbj.png", 250, 250);
      jzhbj = new PIXI.extras.AnimatedSprite(jzhbjArr)
      jzhbj.width = 500
      jzhbj.height = 500
      jzhbj.position.set(0, 300)
      jzhbj.animationSpeed = 0.2;
      jzhbj.loop = false
      jzhbj.onComplete = function () {
        app.stage.addChild(death)
        TweenMax.from(death, 0.5, {
          y: 0,
          ease: Bounce.easeOut,
          onComplete: function () {
            TweenMax.to(death, 0.5, {
              // alpha: 0,
              onComplete: function () {
                // app.stage.removeChild(death)
                xue.stop()
                xue2.stop()
                dialog.style.display = 'block';
                TweenMax.killAll();
                app.stage.filters = [simpleLightmap];
              }
            })

          }
        });
      }

      // 溅血
      let xueArr = su.filmstrip("images/xue2.png", 400, 400);
      xue = new PIXI.extras.AnimatedSprite(xueArr)
      xue.width = 400
      xue.height = 400
      xue.position.set(55, 390)
      xue.animationSpeed = 0.15;
      xue.loop = true
      xue.play()

      let xue2Arr = su.filmstrip("images/xue2.png", 400, 400);
      xue2 = new PIXI.extras.AnimatedSprite(xue2Arr)
      xue2.width = 400
      xue2.height = 400
      xue2.position.set(20, 350)
      xue2.animationSpeed = 0.15;
      xue2.loop = true
      xue2.play()

      // 拔箭区域
      bjArea = new PIXI.Sprite(
        PIXI.loader.resources["images/sshdj.png"].texture
      );
      bjArea.width = 100
      bjArea.height = 40
      bjArea.position.set(260, 540)
      bjArea.interactive = false;
      bjArea.anchor.set(0.5);
      bjArea.on('pointerdown', onDragStart)
        .on('pointerup', onDragEnd2)
        .on('pointerupoutside', onDragEnd2)
        .on('pointermove', onDragMove);
      app.stage.addChild(bjArea)


      // 手势提示
      gestures = new PIXI.Sprite(
        PIXI.loader.resources["images/hand.png"].texture
      );
      gestures.width = 40
      gestures.height = 40
      gestures.position.set(580, 380)
      app.stage.addChild(gestures);
      TweenMax.to(gestures, 1.4, {
        x: 180,
        y: 300,
        repeat: -1,
        yoyo: true,
        ease: Power1.easeInOut
      });

      gestures2 = new PIXI.Sprite(
        PIXI.loader.resources["images/hand.png"].texture
      );
      gestures2.width = 40
      gestures2.height = 40
      gestures2.position.set(580, 200)

      gestures3 = new PIXI.Sprite(
        PIXI.loader.resources["images/hand.png"].texture
      );
      gestures3.width = 40
      gestures3.height = 40
      gestures3.position.set(260, 550)

      // 文字提示
      thanks = new PIXI.Sprite(
        PIXI.loader.resources["images/Thanks.png"].texture
      );
      thanks.width = 307
      thanks.height = 63
      thanks.position.set(180, 180)

      Nice = new PIXI.Sprite(
        PIXI.loader.resources["images/Nice.png"].texture
      );
      Nice.width = 218
      Nice.height = 80
      Nice.position.set(180, 180)

      death = new PIXI.Sprite(
        PIXI.loader.resources["images/death.png"].texture
      );
      death.width = 481
      death.height = 50
      death.position.set(140, 150)

      // install now
      install = new PIXI.Sprite(
        PIXI.loader.resources["images/install.png"].texture
      );
      install.width = 385
      install.height = 104
      install.position.set(375, 80)
      install.anchor.set(0.5, 0.5)
      app.stage.addChild(install)
      TweenMax.from(install, 0.8, {
        width: 350,
        height: 95,
        repeat: -1,
        yoyo: true,
        ease: Power1.easeInOut
      })
      install.interactive = true;
      install.on('pointerdown', function () { 
        FbPlayableAd.onCTAClick()
      })

      // 滤镜
      let kawaseBlur = new PIXI.filters.KawaseBlurFilter(1, 3, 1, 1);
      let simpleLightmap = new PIXI.filters.SimpleLightmapFilter(PIXI.loader.resources["images/lightmap.png"].texture, 0x555555, 0.5);
      TweenMax.to(bucket, 0.6, { width: 120, height: 120, repeat: -1, yoyo: true, ease: SlowMo.ease.config(0.2, 0.2, false) })
      gameLoop();
    }

    let state = play;
    let waterLock = true
    let jLock = true
    let bjLock = true

    function gameLoop() {
      // 循环调用gameLoop
      requestAnimationFrame(gameLoop);
      state();
    }

    // 浇水和脚正检测
    function play() {
      if (hitTestRectangle(fire, bucket) && waterLock) {
        waterLock = false
        app.stage.removeChild(gestures);
        TweenMax.to(bucket, 0.4, {
          rotation: -1,
          ease: Elastic.easeOut.config(1, 0.3),
          onComplete: function () {
            app.stage.removeChild(bucket)
            app.stage.addChild(water)
            water.play();
            water.onComplete = function () {
              app.stage.removeChild(water)
              app.stage.removeChild(fire)
              app.stage.removeChild(dj)
              app.stage.addChild(hh)
              app.stage.addChild(bandage)
              hh.play();
              app.stage.addChild(thanks)
              TweenMax.from(thanks, 0.5, {
                width: 30,
                height: 6,
                ease: Power1.easeInOut,
                onComplete: function () {
                  TweenMax.to(thanks, 0.8, {
                    alpha: 0,
                    onComplete: function () {
                      app.stage.removeChild(thanks)
                    }
                  })
                }
              });
              hh.onComplete = function () {
                app.stage.removeChild(hh)
                app.stage.addChild(dj)
                app.stage.addChild(bandage)
                bandage.interactive = true;
                TweenMax.to(bandage, 0.6, { width: 120, height: 120, repeat: -1, yoyo: true, ease: SlowMo.ease.config(0.2, 0.2, false) })
                app.stage.addChild(gestures2);
                TweenMax.to(gestures2, 1.6, {
                  x: 200,
                  y: 620,
                  repeat: -1,
                  yoyo: true,
                  ease: Power1.easeInOut
                });
              }
            }
          }
        },
        )
      }

      if (hitTestRectangle(sshdj, bandage) && jLock) {
        jLock = false
        app.stage.removeChild(gestures2);
        TweenMax.to(bandage, 0.8, {
          width: 50,
          height: 50,
          ease: Bounce.easeOut,
          onComplete: function () {
            app.stage.removeChild(bandage)
            app.stage.removeChild(dj)
            app.stage.addChild(jzh)
            jzh.play();
            app.stage.addChild(Nice)
            TweenMax.from(Nice, 0.5, {
              width: 22,
              height: 8,
              ease: Power1.easeInOut,
              onComplete: function () {
                TweenMax.to(Nice, 0.8, {
                  alpha: 0,
                  onComplete: function () {
                    app.stage.removeChild(Nice)
                  }
                })
              }
            });
            jzh.onComplete = function () {
              app.stage.removeChild(jzh)
              app.stage.addChild(jzhdj)
              bjArea.interactive = true;
              app.stage.addChild(gestures3);
              TweenMax.to(gestures3, 0.8, {
                x: 400,
                y: 580,
                repeat: -1,
                yoyo: true,
                ease: Power1.easeInOut
              });

            }
          }
        })

      }

      if (bjLock) {
        app.stage.addChild(bjArea)
      }

    }

    // 拖拽
    function onDragStart(event) {
      this.data = event.data;
      this.dragging = true;
    }

    function onDragEnd() {
      this.dragging = false;
      this.data = null;
    }

    function onDragMove() {
      if (this.dragging) {
        const newPosition = this.data.getLocalPosition(this.parent);
        this.x = newPosition.x;
        this.y = newPosition.y;
      }

    }

    // 拔箭动作
    function onDragEnd2() {
      this.dragging = false;
      this.data = null;
      bucket.interactive = false;
      bandage.interactive = false;
      bjLock = false;
      app.stage.removeChild(bjArea)
      app.stage.removeChild(gestures3);
      app.stage.removeChild(jzhdj)
      app.stage.addChild(jzhbj)
      setTimeout(function () {
        jzhbj.play();
        app.stage.addChild(xue)
        app.stage.addChild(xue2)
      }, 100)
    }

    // 碰撞检测
    function hitTestRectangle(r1, r2) {

      //Define the variables we'll need to calculate
      let hit, combinedHalfWidths, combinedHalfHeights, vx, vy;

      //hit will determine whether there's a collision
      hit = false;

      //Find the center points of each sprite
      r1.centerX = r1.x + r1.width / 2;
      r1.centerY = r1.y + r1.height / 2;
      r2.centerX = r2.x + r2.width / 2;
      r2.centerY = r2.y + r2.height / 2;

      //Find the half-widths and half-heights of each sprite
      r1.halfWidth = r1.width / 2;
      r1.halfHeight = r1.height / 2;
      r2.halfWidth = r2.width / 2;
      r2.halfHeight = r2.height / 2;

      //Calculate the distance vector between the sprites
      vx = r1.centerX - r2.centerX;
      vy = r1.centerY - r2.centerY;

      //Figure out the combined half-widths and half-heights
      combinedHalfWidths = r1.halfWidth + r2.halfWidth;
      combinedHalfHeights = r1.halfHeight + r2.halfHeight;

      //Check for a collision on the x axis
      if (Math.abs(vx) < combinedHalfWidths) {

        //A collision might be occuring. Check for a collision on the y axis
        if (Math.abs(vy) < combinedHalfHeights) {

          //There's definitely a collision happening
          hit = true;
        } else {

          //There's no collision on the y axis
          hit = false;
        }
      } else {

        //There's no collision on the x axis
        hit = false;
      }

      //`hit` will be either `true` or `false`
      return hit;
    };

  </script>
</body>

</html>